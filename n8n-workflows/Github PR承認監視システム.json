{
  "name": "Github PR承認監視システム",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "github-pr-merged",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "fbd93a41-a239-44fd-9a48-4f3e46072351",
      "name": "Webhook",
      "webhookId": "d3de2c2f-24c8-4c01-b44c-6ca3d9caafb6"
    },
    {
      "parameters": {
        "jsCode": "  // GitHub WebhookからPRマージイベントを解析\n  const event = $json.body;\n\n  // PRがクローズされた、かつマージされた場合のみ処理\n  if (event.action !== 'closed' || !event.pull_request?.merged) {\n    return {\n      json: {\n        skip: true,\n        reason: 'PR not merged'\n      }\n    };\n  }\n\n  // PR情報を取得\n  const pr = event.pull_request;\n  const prNumber = pr.number;\n  const prTitle = pr.title;\n  const baseBranch = pr.base.ref;\n  const headBranch = pr.head.ref;\n\n  // フェーズ別ブランチのパターンマッチ\n  // 新統一形式: project/{project-name}-{issue-number}-phase{N}\n  // 例: project/csv-analyzer-95-phase1\n  let phaseMatch = headBranch.match(/^project\\/(.+)-(\\d+)-phase(\\d+)$/);\n  let projectName, issueNumber, currentPhase;\n\n  if (phaseMatch) {\n    projectName = phaseMatch[1];\n    issueNumber = phaseMatch[2];\n    currentPhase = parseInt(phaseMatch[3]);\n  } else {\n    // 旧形式のサポート（後方互換性）\n    // 形式1: {project-name}-{issue-number}-phase{N}\n    phaseMatch = headBranch.match(/^(.+)-(\\d+)-phase(\\d+)$/);\n    if (phaseMatch) {\n      projectName = phaseMatch[1];\n      issueNumber = phaseMatch[2];\n      currentPhase = parseInt(phaseMatch[3]);\n    } else {\n      return {\n        json: {\n          skip: true,\n          reason: 'Not a phase branch'\n        }\n      };\n    }\n  }\n\n  if (!issueNumber) {\n    return {\n      json: {\n        skip: true,\n        reason: 'Could not determine issue number'\n      }\n    };\n  }\n\n  const nextPhase = currentPhase + 1;\n\n  // PR本文からFinal Status判定を行う\n  const prBody = pr.body || '';\n  const hasFinalStatus = /####\\s*Final\\s*Status:/i.test(prBody);\n  const isProjectCompleted = hasFinalStatus && /PROJECT\\s*COMPLETED/i.test(prBody);\n\n  // プロジェクト完了時は次フェーズ開始をスキップ\n  if (isProjectCompleted) {\n    return {\n      json: {\n        skip: true,\n        reason: 'Project completed - no next phase needed',\n        project_completed: true,\n        issue_number: issueNumber,\n        project_name: projectName,\n        current_phase: currentPhase\n      }\n    };\n  }\n\n  return {\n    json: {\n      skip: false,\n      issue_number: issueNumber,\n      project_name: projectName,\n      current_phase: currentPhase,\n      next_phase: nextPhase,\n      pr_number: prNumber,\n      pr_title: prTitle,\n      base_branch: baseBranch,\n      head_branch: headBranch\n    }\n  };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        220,
        0
      ],
      "id": "72e41c27-a74c-40e2-8f98-30a1faa173e3",
      "name": "Code"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "920068f0-8f06-444a-a7dd-d442dea4a6c5",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        440,
        0
      ],
      "id": "41ce358b-6fe1-4132-a86b-69ab472c82a6",
      "name": "Filter"
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C094LNGF8H5",
          "mode": "id"
        },
        "text": "=🔄 Phase {{ $('Code').item.json.next_phase }}を自動開始しました\n   プロジェクト: {{ $('Code').item.json.project_name }}\n   Issue: #{{ $('Code').item.json.issue_number }}\n   前フェーズPR: #{{ $('Code').item.json.pr_number }} がマージされました",
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        660,
        0
      ],
      "id": "4853d38b-4a84-4228-9194-c883e089c3e7",
      "name": "Send a message",
      "webhookId": "b506696e-9a7a-4b27-8db7-a50034f74213",
      "credentials": {
        "slackApi": {
          "id": "aHC6dGXUUgCWfDpJ",
          "name": "Slack account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "6e96ba8f-edb0-4aab-af5e-2f955a17ba4c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b9ad821e1bac462e0829b0fcfa0ee54572f5b3a4dad3925c8cb3c5dae1bcef22"
  },
  "id": "yP4ZcyuA2wHoqq5L",
  "tags": []
}