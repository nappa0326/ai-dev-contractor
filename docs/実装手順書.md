# 実装手順書

## 概要

中間レビュー機能と修正・拡張機能を実装するための具体的な手順書です。段階的に実装することで、既存システムへの影響を最小限に抑えながら機能を追加します。

## 実装フェーズ

### Phase 1: Claude Codeの設定更新（1日目）

#### 1-1. GitHub Actionsの設定更新

**ファイル:** `.github/workflows/claude.yml`

**追加内容:**
```yaml
custom_instructions: |
  ## 開発プロセス
  1. 新規プロジェクト開始時は、以下のフェーズに従って開発を進めてください：
     - Phase 1 (20%): 設計書を作成し、ユーザーレビューを待つ
     - Phase 2 (50%): MVPを実装し、ユーザーフィードバックを待つ
     - Phase 3 (80%): 完全実装を行い、最終レビューを待つ
     - Phase 4 (100%): 完成してPRを作成
  
  2. 各レビューポイントで：
     - PRコメントとして進捗報告を投稿
     - タグ「@claude-review-needed」を追加
     - ユーザーの応答を待つ
  
  3. フィードバック受信時：
     - フィードバックを確認して返信
     - 要望された変更を実装
     - 完了報告を行う
  
  4. 修正要望への対応：
     - PRコメントで「@claude」メンションされた場合は修正を実施
     - 同一ブランチで作業を継続
     - 新しいブランチは作成しない
```

#### 1-2. CLAUDE.mdの更新

中間レビューと修正対応に関する説明を追加。

### Phase 2: n8nワークフローの作成（2-3日目）

#### 2-1. GitHub PR監視ワークフロー

**ワークフロー名:** `GitHub PR監視システム`

**ノード構成:**
1. **GitHub Webhook**
   - Event: `pull_request_comment`
   - Filter: コメント本文に `@claude-review-needed` を含む

2. **データ解析（Code）**
   ```javascript
   const comment = $json.body.comment.body;
   const prNumber = $json.body.pull_request.number;
   const phase = comment.match(/Phase (\d)/)?.[1] || 'unknown';
   
   return {
     json: {
       pr_number: prNumber,
       phase: phase,
       comment: comment,
       html_url: $json.body.pull_request.html_url
     }
   };
   ```

3. **Slack通知**
   ```json
   {
     "channel": "C094LNGF8H5",
     "text": "🔔 レビューが必要です",
     "blocks": [
       {
         "type": "section",
         "text": {
           "type": "mrkdwn",
           "text": "*PR #{{pr_number}}* がレビュー待ちです\nフェーズ: {{phase}}\n<{{html_url}}|GitHubで確認>"
         }
       },
       {
         "type": "actions",
         "elements": [
           {
             "type": "button",
             "text": {"type": "plain_text", "text": "承認"},
             "value": "continue_{{pr_number}}"
           },
           {
             "type": "button", 
             "text": {"type": "plain_text", "text": "修正依頼"},
             "value": "revise_{{pr_number}}"
           }
         ]
       }
     ]
   }
   ```

#### 2-2. Slack応答処理ワークフロー

**ワークフロー名:** `Slack開発制御システム`

**ノード構成:**
1. **Slack Trigger**
   - インタラクティブコンポーネント（ボタン）
   - スラッシュコマンド（/continue-dev, /revise-dev）

2. **アクション判定（Code）**
   ```javascript
   const action = $json.body.actions?.[0]?.value || $json.body.text;
   const match = action.match(/(continue|revise)_?(\d+)/);
   
   if (!match) {
     throw new Error('Invalid action format');
   }
   
   return {
     json: {
       action: match[1],
       pr_number: match[2],
       additional_text: $json.body.text?.replace(/^\S+\s+\d+\s*/, '') || ''
     }
   };
   ```

3. **GitHub API（コメント追加）**
   ```javascript
   const body = $json.action === 'continue' 
     ? '@claude continue'
     : `@claude revise: ${$json.additional_text}`;
   
   // GitHub APIでPRにコメントを追加
   ```

#### 2-3. 機能追加ワークフロー

**ワークフロー名:** `機能追加システム`

**ノード構成:**
1. **Slack Webhook**
   - パス: `/add-feature`
   - スラッシュコマンド処理

2. **パラメータ解析（Code）**
   ```javascript
   const text = $json.body.text;
   const match = text.match(/(\d+)\s+"([^"]+)"(?:\s+([^\s]+))?(?:\s+(.+))?/);
   
   if (!match) {
     throw new Error('使用方法: /add-feature [Issue番号] "[機能説明]" [予算] [期限]');
   }
   
   return {
     json: {
       parent_issue: match[1],
       feature: match[2],
       budget: match[3] || '応相談',
       deadline: match[4] || '2週間'
     }
   };
   ```

3. **元Issue情報取得（GitHub API）**
   - 元のIssueから情報を取得
   - 関連するブランチを特定

4. **AI Agent（技術仕様生成）**
   - 追加機能の技術仕様を生成
   - 既存システムとの統合方法を検討

5. **新Issue作成（GitHub API）**
   ```markdown
   ## 機能追加依頼
   
   ### 元のプロジェクト
   - Issue: #{{parent_issue}}
   - ブランチ: {{parent_branch}}
   
   ### 追加機能
   {{feature}}
   
   ### 技術仕様
   {{ai_specification}}
   
   @claude 上記の機能を追加してください。
   ```

### Phase 3: Slackコマンドの実装（4日目）

#### 3-1. Slackアプリの設定更新

**追加するスラッシュコマンド:**

1. `/continue-dev [PR番号]`
   - 説明: 開発を続行
   - URL: https://n8n.oppy-ai.com/webhook/continue-dev

2. `/revise-dev [PR番号] "[修正内容]"`
   - 説明: 修正を依頼
   - URL: https://n8n.oppy-ai.com/webhook/revise-dev

3. `/add-feature [Issue番号] "[機能説明]" [予算] [期限]`
   - 説明: 機能を追加
   - URL: https://n8n.oppy-ai.com/webhook/add-feature

4. `/fix-bug [Issue番号] "[バグ説明]"`
   - 説明: バグを修正
   - URL: https://n8n.oppy-ai.com/webhook/fix-bug

### Phase 4: テストと検証（5-6日目）

#### 4-1. テストシナリオ

**シナリオ1: 中間レビューフロー**
1. テスト用のIssueを作成
2. Claude Codeが設計書を作成
3. レビュー通知がSlackに届く
4. 承認/修正依頼を送信
5. Claude Codeが適切に応答

**シナリオ2: 修正要望フロー**
1. 完成したPRに修正コメント
2. Claude Codeが修正を実施
3. 修正完了の確認

**シナリオ3: 機能追加フロー**
1. `/add-feature`コマンドを実行
2. 新Issueが作成される
3. Claude Codeが機能を追加
4. 別PRとして提出

#### 4-2. 検証項目

- [ ] Claude Codeが各フェーズで適切に停止するか
- [ ] Slack通知が正しく送信されるか
- [ ] ユーザー応答が正しく処理されるか
- [ ] 修正が同一ブランチで行われるか
- [ ] 機能追加が別ブランチで行われるか
- [ ] エラーハンドリングが適切か

### Phase 5: 本番導入（7日目）

#### 5-1. 段階的ロールアウト

1. **パイロット運用**
   - 特定のプロジェクトでのみ有効化
   - 問題点の洗い出し

2. **全面展開**
   - 全ての新規プロジェクトで有効化
   - 既存プロジェクトへの適用

#### 5-2. モニタリング

- レビュー待ち時間の測定
- 修正要望の頻度と内容
- システムエラーの監視

## トラブルシューティング

### よくある問題と対処法

1. **Claude Codeが停止しない**
   - custom_instructionsが正しく設定されているか確認
   - GitHub Actionsのログを確認

2. **Slack通知が届かない**
   - n8nワークフローのエラーログを確認
   - Webhookの設定を確認

3. **修正が新しいブランチで行われる**
   - Claude Codeの指示に「同一ブランチで作業」が含まれているか確認

## 運用マニュアル

### 日次チェック項目

- [ ] エラーログの確認
- [ ] 滞留しているレビューの確認
- [ ] システム稼働状況の確認

### 週次レポート項目

- プロジェクト数と完了率
- 平均レビュー時間
- 修正要望の傾向分析
- システム改善提案

## 今後の拡張案

1. **自動承認機能**
   - 軽微な変更は自動承認
   - 条件設定の柔軟化

2. **レビュアー指定**
   - 特定のユーザーをレビュアーに指定
   - 承認フローの階層化

3. **品質メトリクス**
   - コード品質の自動評価
   - パフォーマンステスト結果の統合

4. **ダッシュボード**
   - プロジェクト進捗の可視化
   - KPIのリアルタイム表示