# 開発完了通知仕様書

## 概要
AI開発請負システムにおいて、プロジェクトの開発完了時に適切な通知を行うシステムの仕様を定義する。

## 完了判定の条件

### 1. Phase 4完了の判定
以下のいずれかの条件を満たした場合、Phase 4完了と判定する：

- **条件A**: コメントに以下のすべてが含まれる
  - "Phase 4" または "フェーズ4"
  - "完了" または "COMPLETE" または "✅"
  - "@claude-review-needed"タグ
  
- **条件B**: PR作成の検出
  - 新規PRが作成される
  - PRのタイトルまたは説明に該当Issue番号が含まれる
  - ブランチ名が `claude/issue-{番号}-*` パターン

- **条件C**: 特定のキーワード組み合わせ
  - "プルリクエスト準備完了"
  - "本番デプロイ準備完了"
  - "すべてのPhase 1-4が完成"

### 2. 通知タイミング

1. **即時通知**（Phase 4完了検出時）
   - 基本情報のみの簡易通知
   
2. **詳細通知**（5分後）
   - 開発統計情報を含む詳細通知
   - PRが作成されている場合はPR情報も含む

## 通知内容

### 即時通知に含める情報
```
🎉 開発完了通知

プロジェクト: {プロジェクト名}
Issue: #{issue_number}
完了時刻: {timestamp}
ブランチ: {branch_name}

✅ Phase 4が完了しました
```

### 詳細通知に含める情報
```
📊 開発完了レポート

プロジェクト: {プロジェクト名}
Issue: #{issue_number}
PR: #{pr_number}（作成済みの場合）

開発統計:
- 開発期間: {開始〜終了}
- 総コミット数: {count}
- 変更ファイル数: {count}
- 追加行数: +{count}
- 削除行数: -{count}

フェーズ別完了時刻:
- Phase 1: {timestamp}
- Phase 2: {timestamp}
- Phase 3: {timestamp}
- Phase 4: {timestamp}

成果物:
- プロジェクトディレクトリ: {directory_name}/
- 主要技術: {tech_stack}
- ドキュメント: README.md, API仕様書など

アクション:
[GitHubで確認] [PRを確認] [成果物をダウンロード]
```

## 実装方法

### 1. GitHub Webhook設定
- Issue comment イベント
- Pull request イベント（created）

### 2. n8nワークフロー構成

#### A. 既存の「Github PR監視システム」の改修
1. Codeノードの判定ロジック修正
2. Phase 4専用の判定追加
3. ボット名の修正（claude）

#### B. 新規「開発統計収集」ワークフロー
1. GitHub APIを使用した統計情報収集
2. コミット履歴の分析
3. ファイル変更の集計

#### C. Slack通知の改善
1. リッチな通知フォーマット
2. インタラクティブボタン
3. スレッド形式での追加情報

### 3. エラーハンドリング
- GitHub API制限への対応
- 統計情報取得失敗時のフォールバック
- 通知失敗時の再試行

## 実装優先順位

1. **Phase 1**: 基本的な完了検出と通知（既存システムの修正）
2. **Phase 2**: 詳細統計情報の収集と表示
3. **Phase 3**: インタラクティブ機能とダウンロード機能

## テスト計画

1. **単体テスト**
   - 各種コメントパターンでの判定テスト
   - 統計情報収集の正確性テスト

2. **統合テスト**
   - 実際のIssue/PRでの動作確認
   - 通知の到達確認

3. **エッジケース**
   - 同時に複数の完了通知
   - API制限時の動作
   - 不完全なデータでの動作