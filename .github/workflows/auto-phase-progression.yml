name: Auto Phase Progression

on:
  pull_request:
    types: [closed]
    branches:
      - 'project/**'

jobs:
  check-and-progress:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract phase information
      id: phase_info
      run: |
        # PRã®ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
        HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
        BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
        echo "Head branch: $HEAD_BRANCH"
        echo "Base branch: $BASE_BRANCH"
        
        # æ–°çµ±ä¸€å½¢å¼: project/{project-name}-{issue-number}-phase{N}
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®æŠ½å‡ºï¼ˆãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ï¼‰
        if [[ $BASE_BRANCH =~ ^project/(.+)$ ]]; then
          PROJECT_NAME="${BASH_REMATCH[1]}"
        else
          echo "Not a project branch PR, skipping..."
          echo "is_phase_branch=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã®æŠ½å‡ºï¼ˆãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ï¼‰
        if [[ $HEAD_BRANCH =~ ^project/${PROJECT_NAME}-([0-9]+)-phase([0-9]+)$ ]]; then
          ISSUE_NUMBER="${BASH_REMATCH[1]}"
          CURRENT_PHASE="${BASH_REMATCH[2]}"
        elif [[ $HEAD_BRANCH =~ ^${PROJECT_NAME}-([0-9]+)-phase([0-9]+)$ ]]; then
          # æ—§å½¢å¼ã®ã‚µãƒãƒ¼ãƒˆ
          ISSUE_NUMBER="${BASH_REMATCH[1]}"
          CURRENT_PHASE="${BASH_REMATCH[2]}"
        else
          echo "Not a phase branch, skipping..."
          echo "is_phase_branch=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        NEXT_PHASE=$((CURRENT_PHASE + 1))
        
        echo "Project: $PROJECT_NAME"
        echo "Issue: #$ISSUE_NUMBER"
        echo "Current Phase: $CURRENT_PHASE"
        echo "Next Phase: $NEXT_PHASE"
        
        # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å‡ºåŠ›
        echo "is_phase_branch=true" >> $GITHUB_OUTPUT
        echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
        echo "current_phase=$CURRENT_PHASE" >> $GITHUB_OUTPUT
        echo "next_phase=$NEXT_PHASE" >> $GITHUB_OUTPUT

    - name: Check for Final Status in PR description
      if: steps.phase_info.outputs.is_phase_branch == 'true'
      id: final_check
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueNumber = ${{ steps.phase_info.outputs.issue_number }};
          
          // PRã®æœ¬æ–‡ã‚’ç¢ºèª
          const prNumber = context.payload.pull_request.number;
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          const prBodyHasFinalStatus = /####\s*Final\s*Status:/i.test(pr.data.body || '');
          console.log(`PR body has Final Status: ${prBodyHasFinalStatus}`);
          
          // æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¦Final Statusã‚’ç¢ºèª
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            per_page: 100
          });
          
          // Claude botã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€†é †ã§ç¢ºèªï¼ˆæœ€æ–°ã‹ã‚‰ï¼‰
          const claudeComments = comments.data
            .filter(c => c.user.login === 'claude[bot]')
            .reverse();
          
          // Final Status:ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆIssueã‚³ãƒ¡ãƒ³ãƒˆï¼‰
          const commentHasFinalStatus = claudeComments.some(comment => 
            /####\s*Final\s*Status:/i.test(comment.body)
          );
          
          // PRæœ¬æ–‡ã¾ãŸã¯Issueã‚³ãƒ¡ãƒ³ãƒˆã®ã„ãšã‚Œã‹ã«Final StatusãŒã‚ã‚Œã°true
          const hasFinalStatus = prBodyHasFinalStatus || commentHasFinalStatus;
          
          console.log(`Issue comment has Final Status: ${commentHasFinalStatus}`);
          console.log(`Final Status found (PR or comment): ${hasFinalStatus}`);
          return hasFinalStatus;

    - name: Post phase progression comment
      if: steps.phase_info.outputs.is_phase_branch == 'true' && steps.final_check.outputs.result != 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PAT_WITH_REPO_SCOPE }}
        script: |
          const issueNumber = ${{ steps.phase_info.outputs.issue_number }};
          const nextPhase = ${{ steps.phase_info.outputs.next_phase }};
          const currentPhase = ${{ steps.phase_info.outputs.current_phase }};
          const projectName = '${{ steps.phase_info.outputs.project_name }}';
          
          // Phaseé€²è¡Œã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          const prNumber = context.payload.pull_request.number;
          
          // Phase 2-3ã®å ´åˆã¯å“è³ªãƒã‚§ãƒƒã‚¯ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¿½åŠ 
          let qualityReminder = '';
          if (currentPhase === '2' || currentPhase === '3') {
            qualityReminder = [
              '',
              '**ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼**:',
              '- ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
              '- åŸºæœ¬çš„ãªå‹•ä½œç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„',
              '- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºæœ¬ï¼ˆAPIã‚­ãƒ¼ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç­‰ï¼‰ã«æ³¨æ„ã—ã¦ãã ã•ã„',
            ].join('\n');
          }
          
          const comment = [
            `@claude Phase ${nextPhase}ã‚’é–‹å§‹ã—ã¦ãã ã•ã„`,
            '',
            `å‰ãƒ•ã‚§ãƒ¼ã‚ºã®PR #${prNumber} ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚`,
            qualityReminder,
            '',
            '**é‡è¦**: ',
            `- ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: \`project/${projectName}\``,
            `- æ–°ã—ã„ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒ: \`project/${projectName}-${issueNumber}-phase${nextPhase}\``,
            '- å¿…ãšãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„'
          ].join('\n');
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            body: comment
          });
          
          console.log(`Posted phase progression comment to issue #${issueNumber}`);

    - name: Post completion notification
      if: steps.phase_info.outputs.is_phase_branch == 'true' && steps.final_check.outputs.result == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueNumber = ${{ steps.phase_info.outputs.issue_number }};
          const projectName = '${{ steps.phase_info.outputs.project_name }}';
          
          console.log(`Project ${projectName} (Issue #${issueNumber}) has been completed with Final Status marker.`);

    - name: Notify n8n webhook
      if: steps.phase_info.outputs.is_phase_branch == 'true'
      env:
        N8N_WEBHOOK_URL: ${{ secrets.N8N_PHASE_PROGRESSION_WEBHOOK_URL }}
      run: |
        # n8nã®Webhookã‚’å‘¼ã³å‡ºã—ã¦Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        WEBHOOK_URL="${N8N_WEBHOOK_URL}"
        
        # Final Statusã®æœ‰ç„¡ã‚’åˆ¤å®š
        IS_FINAL="${{ steps.final_check.outputs.result }}"
        
        # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
        PAYLOAD=$(cat <<EOF
        {
          "event_type": "phase_progression",
          "project_name": "${{ steps.phase_info.outputs.project_name }}",
          "issue_number": "${{ steps.phase_info.outputs.issue_number }}",
          "current_phase": "${{ steps.phase_info.outputs.current_phase }}",
          "next_phase": "${{ steps.phase_info.outputs.next_phase }}",
          "pr_number": "${{ github.event.pull_request.number }}",
          "pr_title": "${{ github.event.pull_request.title }}",
          "is_final_status": "$IS_FINAL",
          "proceed_to_next": "$([[ "$IS_FINAL" == "true" ]] && echo "false" || echo "true")"
        }
        EOF
        )
        
        # Webhookã‚’é€ä¿¡ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
        curl -X POST \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD" \
          "$WEBHOOK_URL" || echo "Warning: n8n webhook notification failed"