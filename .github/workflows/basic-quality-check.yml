name: Basic Quality Check

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  basic-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Detect and setup environment
        id: setup
        run: |
          # Node.js project
          if [ -f "package.json" ]; then
            echo "project_type=node" >> $GITHUB_OUTPUT
            echo "::notice::Node.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œå‡º"
          # Python project
          elif [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
            echo "project_type=python" >> $GITHUB_OUTPUT
            echo "::notice::Pythonãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œå‡º"
          # Go project
          elif [ -f "go.mod" ]; then
            echo "project_type=go" >> $GITHUB_OUTPUT
            echo "::notice::Goãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œå‡º"
          else
            echo "project_type=unknown" >> $GITHUB_OUTPUT
            echo "::warning::ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’ç‰¹å®šã§ãã¾ã›ã‚“"
          fi
          
      - name: Setup Node.js
        if: steps.setup.outputs.project_type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup Python
        if: steps.setup.outputs.project_type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Setup Go
        if: steps.setup.outputs.project_type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          
      - name: Try to build
        id: build
        continue-on-error: true
        run: |
          cd $(find . -name "package.json" -o -name "requirements.txt" -o -name "go.mod" | head -1 | xargs dirname)
          
          if [ "${{ steps.setup.outputs.project_type }}" == "node" ]; then
            npm install && npm run build
          elif [ "${{ steps.setup.outputs.project_type }}" == "python" ]; then
            pip install -r requirements.txt || pip install .
          elif [ "${{ steps.setup.outputs.project_type }}" == "go" ]; then
            go build ./...
          fi
          
      - name: Check for obvious security issues
        run: |
          # APIã‚­ãƒ¼ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          if grep -r "api[_-]key.*=.*['\"].*['\"]" --exclude-dir=.git --exclude-dir=node_modules .; then
            echo "::warning::APIã‚­ãƒ¼ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          fi
          
          if grep -r "password.*=.*['\"].*['\"]" --exclude-dir=.git --exclude-dir=node_modules .; then
            echo "::warning::ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒ“ãƒ«ãƒ‰: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**å¯¾å‡¦æ³•**: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ ã“ã‚Œã¯åŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯ã§ã™ã€‚è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯äººé–“ãŒè¡Œã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY