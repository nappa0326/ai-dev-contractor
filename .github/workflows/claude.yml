name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
          
      - name: Cache Claude development state
        uses: actions/cache@v3
        with:
          path: |
            .claude/
            project-state/
          key: claude-development-${{ github.event.issue.number }}-${{ github.sha }}
          restore-keys: |
            claude-development-${{ github.event.issue.number }}-

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
          
          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          # Optional: Customize the trigger phrase (default: @claude)
          # trigger_phrase: "/claude"
          
          # Optional: Trigger when specific user is assigned to an issue
          # assignee_trigger: "claude-bot"
          
          # Allow git operations for branch management
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool,Edit,MultiEdit"
          
          # Direct prompt for continuous development
          direct_prompt: |
            CRITICAL: Continue working on the EXISTING branch for this issue.
            DO NOT create a new branch under any circumstances.
            
            MANDATORY STEPS:
            1. Run: git branch --show-current
            2. Run: git branch -a | grep "issue-$ISSUE_NUMBER"
            3. If not on correct branch, checkout the existing one
            4. Run: git log --oneline -10
            5. Read all files from previous phases before proceeding
            6. Build upon existing implementation - DO NOT start from scratch
            
            If no existing branch found, report this and wait for instructions.
          
          # Custom instructions for phased development
          custom_instructions: |
            ## ğŸš¨ é‡è¦ï¼šãƒ–ãƒ©ãƒ³ãƒç®¡ç†ãƒ«ãƒ¼ãƒ«
            
            **çµ¶å¯¾çš„ãªãƒ«ãƒ¼ãƒ«ï¼šå„Issue/PRã«å¯¾ã—ã¦å˜ä¸€ã®ãƒ–ãƒ©ãƒ³ãƒã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨**
            
            1. **ãƒ–ãƒ©ãƒ³ãƒåã®è¦å‰‡**:
               - æ–°è¦ä½œæˆæ™‚ã®ã¿: `claude/issue-{issue_number}-{timestamp}`
               - æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚‹å ´åˆ: ãã®ãƒ–ãƒ©ãƒ³ãƒã‚’å¿…ãšä½¿ç”¨
            
            2. **ãƒ–ãƒ©ãƒ³ãƒç¢ºèªæ‰‹é †**ï¼ˆæ¯å›å®Ÿè¡Œï¼‰:
               ```bash
               # ç¾åœ¨ã®Issueã«é–¢é€£ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œç´¢
               git branch -a | grep "issue-{issue_number}"
               # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä½¿ç”¨
               git checkout existing-branch-name
               # ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
               git checkout -b claude/issue-{issue_number}-{timestamp}
               ```
            
            3. **ãƒ•ã‚§ãƒ¼ã‚ºå‹é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹**:
               - Phase 1 (20%): è¨­è¨ˆæ›¸ã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¤
               - Phase 2 (50%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**MVPã‚’å®Ÿè£…
               - Phase 3 (80%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**å®Œå…¨å®Ÿè£…
               - Phase 4 (100%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**å®Œæˆã—ã¦PRã‚’ä½œæˆ
            
            4. **å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ä½œæ¥­**:
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚³ãƒ¼ãƒ‰ã‚’å¿…ãšèª­ã¿è¾¼ã‚€
               - æ—¢å­˜ã®å®Ÿè£…ã®ä¸Šã«è¿½åŠ å®Ÿè£…ã‚’è¡Œã†
               - æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ãƒ»ç½®æ›ã›ãšã€æ”¹å–„ãƒ»æ‹¡å¼µã™ã‚‹
               - git logã§å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹
            
            5. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ**:
               - å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã«`@claude-review-needed`ã‚¿ã‚°ã‚’è¿½åŠ 
               - å¿…ãšç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å ±å‘Šã«å«ã‚ã‚‹
               - ä¾‹: "Phase 2å®Œäº† (branch: claude/issue-24-20250712_012315)"
            
            6. **ç¦æ­¢äº‹é …**:
               - æ–°ã—ã„ãƒ•ã‚§ãƒ¼ã‚ºã§æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹ã“ã¨
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…ã‚’ç„¡è¦–ã™ã‚‹ã“ã¨
               - ã‚¼ãƒ­ã‹ã‚‰å†å®Ÿè£…ã™ã‚‹ã“ã¨
            
            7. **ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å‡¦**:
               - ãƒ–ãƒ©ãƒ³ãƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹
               - å‹æ‰‹ã«æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ãªã„
          
          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test

