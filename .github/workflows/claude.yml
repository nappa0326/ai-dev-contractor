name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Changed from read to write for git push
      pull-requests: write  # Changed to allow PR creation
      issues: write  # Changed to allow issue updates
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
          # Always fetch all branches to find existing ones
          fetch-tags: true
          # Use the default GITHUB_TOKEN for write access
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cache Claude development state
        uses: actions/cache@v3
        with:
          path: |
            .claude/
            project-state/
          key: claude-development-${{ github.event.issue.number }}-${{ github.sha }}
          restore-keys: |
            claude-development-${{ github.event.issue.number }}-

      - name: Configure git
        run: |
          git config --global user.name "claude[bot]"
          git config --global user.email "claude[bot]@users.noreply.github.com"
          
      - name: Setup branch tracking
        run: |
          # Fetch all remote branches
          git fetch --all --prune
          
          # Check for existing branch related to this issue
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Check for project branch pattern
          PROJECT_BRANCH=$(git branch -a | grep -E "remotes/origin/project/.*[-/]claude[-/]issue-${ISSUE_NUMBER}" | head -1 | sed 's/remotes\/origin\///' | xargs)
          
          if [ -n "$PROJECT_BRANCH" ]; then
            echo "Found project branch: $PROJECT_BRANCH"
            git checkout -b "$PROJECT_BRANCH" "origin/$PROJECT_BRANCH" || git checkout "$PROJECT_BRANCH"
            echo "CLAUDE_EXISTING_BRANCH=$PROJECT_BRANCH" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=$PROJECT_BRANCH" >> $GITHUB_ENV
          else
            echo "No existing branch found for issue $ISSUE_NUMBER"
            echo "CLAUDE_EXISTING_BRANCH=" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # Specify base branch for continuity (commented out - may not be implemented yet)
          # base_branch: ${{ env.CLAUDE_BASE_BRANCH }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
          
          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          # Optional: Customize the trigger phrase (default: @claude)
          # trigger_phrase: "/claude"
          
          # Optional: Trigger when specific user is assigned to an issue
          # assignee_trigger: "claude-bot"
          
          # Allow git operations for branch management and quality checks
          allowed_tools: >-
            Bash
            View
            GlobTool
            GrepTool
            BatchTool
            Edit
            MultiEdit
            Read
            Write
          
          # Direct prompt for continuous development
          direct_prompt: |
            CRITICAL RULES - MUST FOLLOW REGARDLESS OF PROJECT COMPLEXITY:
            
            1. PHASED DEVELOPMENT IS MANDATORY
               - ALWAYS implement in 4 separate phases
               - NEVER complete multiple phases in one execution
               - Each phase MUST end with @claude-review-needed tag
               - Wait for user approval before proceeding to next phase
            
            2. Branch management for Issue #${{ github.event.issue.number }}
            
            Current situation:
            ${{ env.CLAUDE_EXISTING_BRANCH && format('- Existing branch found: {0}', env.CLAUDE_EXISTING_BRANCH) || '- No existing branch found (this appears to be Phase 1)' }}
            
            MANDATORY WORKFLOW:
            1. First, check current branch: git branch --show-current
            2. Search for existing branches: git branch -a | grep -E "project/.*/claude/issue-${{ github.event.issue.number }}"
            
            3. Decision logic for NEW PROJECTS (Phase 1):
               - Check if issue contains [project: xxx] or [extends: #XX] tags
               - If tags exist â†’ This is continuation work, skip to step 4
               - Extract project name from issue title (kebab-case conversion)
                 Example: "ã‚·ãƒ³ãƒ—ãƒ«ãªååˆºç”»åƒç”ŸæˆCLIãƒ„ãƒ¼ãƒ«" â†’ "meishi-generator"
                 Rule: Remove "- AIè‡ªå‹•é–‹ç™ºæ¡ˆä»¶" suffix and convert to English kebab-case
               - Create project main branch: git checkout -b project/{project-name}
               - Create project directory and .project.yml
               - Push project branch: git push -u origin project/{project-name}
               - Create working branch: git checkout -b project/{project-name}/claude/issue-${{ github.event.issue.number }}-initial
            
            4. Decision logic for CONTINUING WORK:
               - For Phase 2+ of same issue â†’ Use existing branch (NEVER create new)
                 - git checkout {existing-branch}
                 - git pull origin {existing-branch}
               - For new feature/bugfix on existing project ([project: xxx] tag):
                 - git checkout project/{project-name}
                 - git pull origin project/{project-name}
                 - git checkout -b project/{project-name}/claude/issue-${{ github.event.issue.number }}-{feature}
            
            5. For Phase 1 ONLY - MANDATORY PROJECT DIRECTORY:
               - Create project-specific directory with kebab-case naming
               - Examples: "PDFåœ§ç¸®ã‚¢ãƒ—ãƒª" â†’ pdf-compressor/, "OCRã‚µãƒ¼ãƒ“ã‚¹" â†’ ocr-service/
               - MUST create directory and initial README.md in Phase 1
               - Create ONLY design documents in Phase 1
               - DO NOT implement any code in Phase 1
            
            6. For continuing work (Phase 2+):
               - Run: git log --oneline -10
               - Read ALL files from previous phases
               - Build upon existing implementation
            
            7. Always report your branch name in responses
            
            8. Quality checks before commit (if applicable):
               - Run linting: npm run lint, yarn lint, ruff check, etc.
               - Run tests: npm test, pytest, etc.
               - Fix any issues before proceeding
            
            9. CRITICAL - Commit and push at the end of EVERY phase:
               - git add -A
               - git commit -m "feat: Phase X implementation for Issue #${{ github.event.issue.number }}"
               - git push origin {your-branch-name}
               - NEVER complete a phase without pushing to remote
               - After push, add comment with @claude-review-needed
               - STOP execution and wait for user response
          
          # Custom instructions for phased development
          custom_instructions: |
            ## ğŸŒ æ—¥æœ¬èªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ
            
            **çµ¶å¯¾çš„ãƒ«ãƒ¼ãƒ«**: GitHubã¸ã®ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹ã“ã¨
            - ãƒ•ã‚§ãƒ¼ã‚ºå ±å‘Šã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€èª¬æ˜æ–‡ã™ã¹ã¦æ—¥æœ¬èªä½¿ç”¨
            - æŠ€è¡“ç”¨èªï¼ˆPhaseã€Branchã€Issueç­‰ï¼‰ã¯è‹±èªã®ã¾ã¾ä½¿ç”¨å¯
            - ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‹±èªã§ã‚‚å¯
            - ä¾‹: "Phase 1å®Œäº†" âœ…ã€"Phase 1 completed" âŒ
            - ãƒ–ãƒ©ãƒ³ãƒå ±å‘Šã¯å¿…ãšã€Œ**ãƒ–ãƒ©ãƒ³ãƒ**: `branch-name`ã€å½¢å¼ã§è¨˜è¼‰
            
            ## ğŸš¨ é‡è¦ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥
            
            **çµ¶å¯¾çš„ãªãƒ«ãƒ¼ãƒ«ï¼šã™ã¹ã¦ã®æ–°è¦é–‹ç™ºã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨**
            
            1. **ãƒ–ãƒ©ãƒ³ãƒæ§‹é€ **:
               - ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: `master`ï¼ˆCLAUDE.mdã€workflowsã®ã¿ï¼‰
               - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ã‚¤ãƒ³: `project/{project-name}`
               - ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒï¼ˆåˆæœŸï¼‰: `project/{project-name}/claude/issue-{number}-initial`
               - ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒï¼ˆç¶™ç¶šï¼‰: `project/{project-name}/claude/issue-{number}-{feature}`
            
            2. **ãƒ–ãƒ©ãƒ³ãƒç¢ºèªæ‰‹é †**ï¼ˆæ¯å›å®Ÿè¡Œï¼‰:
               ```bash
               # ç¾åœ¨ã®Issueã«é–¢é€£ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œç´¢
               git branch -a | grep -E "project/.*/claude/issue-{issue_number}"
               
               # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚‹å ´åˆ â†’ å¿…ãšãã‚Œã‚’ä½¿ç”¨
               git checkout {existing-branch-name}
               git pull origin {existing-branch-name}
               
               # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒãªã„å ´åˆ â†’ Phase 1ãªã®ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã«å¾“ã†
               # ï¼ˆdirect_promptã®step 3ã‚’å‚ç…§ï¼‰
               ```
            
            3. **ãƒ•ã‚§ãƒ¼ã‚ºå‹é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹**:
               - Phase 1 (20%): è¨­è¨ˆæ›¸ã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¤
               - Phase 2 (50%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**MVPã‚’å®Ÿè£…
               - Phase 3 (80%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**å®Œå…¨å®Ÿè£…
               - Phase 4 (100%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**å“è³ªå‘ä¸Šãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
            
            ## ğŸ“Œ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ã¨PRä½œæˆ
            
            **ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1-4ï¼‰ãŒå®Œäº†ã—ã€ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã—ãŸã‚‰**ï¼š
            - ã™ã¹ã¦ã®å®Ÿè£…ãŒå®Œäº†
            - ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ•´å‚™æ¸ˆã¿
            - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†
            
            **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†æ™‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒã¸PRã‚’ä½œæˆ**ï¼š
            ```bash
            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒã¸PRã‚’ä½œæˆ
            gh pr create --base project/{project-name} \
                         --title "feat: Issue #${{ github.event.issue.number }} - [æ©Ÿèƒ½èª¬æ˜]" \
                         --body "## å®Ÿè£…å†…å®¹\n[å®Ÿè£…å†…å®¹ã®è¦ç´„]\n\nCloses #${{ github.event.issue.number }}"
            ```
            
            æ³¨æ„ï¼š
            - PRã‚¿ã‚¤ãƒˆãƒ«ã®[æ©Ÿèƒ½èª¬æ˜]ã¯å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®ç°¡æ½”ãªèª¬æ˜ã«ç½®ãæ›ãˆã‚‹
            - PRæœ¬æ–‡ã®[å®Ÿè£…å†…å®¹ã®è¦ç´„]ã¯å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®æ¦‚è¦ã‚’è¨˜è¼‰
            - PRä½œæˆå¾Œã€è‡ªå‹•çš„ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã‚’æ¤œå‡º
            
            ## ğŸš¨ å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®å¿…é ˆä½œæ¥­
            **çµ¶å¯¾çš„ãƒ«ãƒ¼ãƒ«ï¼šå„ãƒ•ã‚§ãƒ¼ã‚ºã®ä½œæ¥­ã‚’å®Œäº†ã™ã‚‹å‰ã«å¿…ãšä»¥ä¸‹ã‚’å®Ÿè¡Œ**
            
            ```bash
            # 1. ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
            git add -A
            
            # 2. ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚’ã‚³ãƒŸãƒƒãƒˆ
            git commit -m "feat: Phase X implementation for Issue #${{ github.event.issue.number }}"
            
            # 3. ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆã“ã‚Œã‚’å¿˜ã‚Œã‚‹ã¨æ¬¡å›æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒãŒä½œæˆã•ã‚Œã‚‹ï¼ï¼‰
            git push origin {ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒå}
            ```
            
            **è­¦å‘Š**: ãƒ—ãƒƒã‚·ãƒ¥ã‚’å¿˜ã‚Œã‚‹ã¨ã€æ¬¡å›ã®å®Ÿè¡Œæ™‚ã«æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒè¦‹ã¤ã‹ã‚‰ãšã€
            æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒãŒä½œæˆã•ã‚Œã¦ã—ã¾ã„ã€ãƒ•ã‚§ãƒ¼ã‚ºé–“ã®é€£ç¶šæ€§ãŒå¤±ã‚ã‚Œã¾ã™ã€‚
            
            4. **å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ä½œæ¥­**:
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚³ãƒ¼ãƒ‰ã‚’å¿…ãšèª­ã¿è¾¼ã‚€
               - æ—¢å­˜ã®å®Ÿè£…ã®ä¸Šã«è¿½åŠ å®Ÿè£…ã‚’è¡Œã†
               - æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ãƒ»ç½®æ›ã›ãšã€æ”¹å–„ãƒ»æ‹¡å¼µã™ã‚‹
               - git logã§å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹
            
            5. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ**:
               - å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã«`@claude-review-needed`ã‚¿ã‚°ã‚’è¿½åŠ 
               - å¿…ãšç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å ±å‘Šã«å«ã‚ã‚‹
               - ä¾‹: "Phase 2å®Œäº† (branch: project/pdf-compressor/claude/issue-24-initial) @claude-review-needed"
            
            6. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†åˆ¤å®š**:
               - ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã—ã¦ã‚‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯è‡ªå‹•å®Œäº†ã—ãªã„
               - å“è³ªåŸºæº–ã‚’æº€ãŸã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªçŠ¶æ…‹ã«ãªã£ãŸã‚‰å®Œäº†
               - å®Œäº†æ™‚ã¯gh pr createã‚³ãƒãƒ³ãƒ‰ã§PRã‚’ä½œæˆ
            
            7. **ç¦æ­¢äº‹é …**:
               - æ–°ã—ã„ãƒ•ã‚§ãƒ¼ã‚ºã§æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹ã“ã¨
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…ã‚’ç„¡è¦–ã™ã‚‹ã“ã¨
               - ã‚¼ãƒ­ã‹ã‚‰å†å®Ÿè£…ã™ã‚‹ã“ã¨
            
            8. **ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å‡¦**:
               - ãƒ–ãƒ©ãƒ³ãƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹
               - å‹æ‰‹ã«æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ãªã„
          
          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test

