name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Changed from read to write for git push
      pull-requests: write  # Changed to allow PR creation
      issues: write  # Changed to allow issue updates
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
          # Always fetch all branches to find existing ones
          fetch-tags: true
          # Use the default GITHUB_TOKEN for write access
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cache Claude development state
        uses: actions/cache@v3
        with:
          path: |
            .claude/
            project-state/
          key: claude-development-${{ github.event.issue.number }}-${{ github.sha }}
          restore-keys: |
            claude-development-${{ github.event.issue.number }}-

      - name: Configure git
        run: |
          git config --global user.name "claude[bot]"
          git config --global user.email "claude[bot]@users.noreply.github.com"
          
      - name: Setup branch tracking
        run: |
          # Fetch all remote branches
          git fetch --all --prune
          
          # Check for existing branch related to this issue
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Detect current phase from issue comments or determine from context
          PHASE_NUMBER=1
          
          # Check if this is a manual phase trigger (e.g., "@claude Phase 2を開始してください")
          if [[ "${{ github.event.comment.body }}" =~ Phase[[:space:]]([0-9]) ]]; then
            DETECTED_PHASE=${BASH_REMATCH[1]}
            PHASE_NUMBER=$DETECTED_PHASE
          else
            # Detect phase from existing branches
            # 新しいパターン: project/{project-name}-{issue-number}-phase{N}
            EXISTING_PHASES=$(git branch -a | grep -E "remotes/origin/project/[^-]+-$ISSUE_NUMBER-phase[0-9]+" | grep -oE "phase[0-9]+" | grep -oE "[0-9]+" | sort -n | tail -1)
            if [ -n "$EXISTING_PHASES" ]; then
              # If phases exist, we're continuing from the last phase
              PHASE_NUMBER=$((EXISTING_PHASES + 1))
            fi
          fi
          
          echo "CLAUDE_PHASE_NUMBER=$PHASE_NUMBER" >> $GITHUB_ENV
          
          # Check for project branch pattern based on existing issue branches
          # 新しいパターン: project/{project-name}-{issue-number}-phase{N}
          PROJECT_NAME=$(git branch -a | grep -E "remotes/origin/project/[^-]+-$ISSUE_NUMBER-phase[0-9]+" | head -1 | sed -E "s|remotes/origin/(project/[^-]+)-$ISSUE_NUMBER-phase[0-9]+|\1|" | xargs)
          
          if [ -n "$PROJECT_NAME" ]; then
            PROJECT_BRANCH="$PROJECT_NAME"
            echo "Found project branch from existing phases: $PROJECT_BRANCH"
            git checkout -b "$PROJECT_BRANCH" "origin/$PROJECT_BRANCH" || git checkout "$PROJECT_BRANCH"
            git pull origin "$PROJECT_BRANCH" || echo "No remote branch yet"
            echo "CLAUDE_PROJECT_BRANCH=$PROJECT_BRANCH" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=$PROJECT_BRANCH" >> $GITHUB_ENV
          else
            echo "No project branch found for issue $ISSUE_NUMBER"
            echo "CLAUDE_PROJECT_BRANCH=" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # Specify base branch for continuity (commented out - may not be implemented yet)
          # base_branch: ${{ env.CLAUDE_BASE_BRANCH }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
          
          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          # Optional: Customize the trigger phrase (default: @claude)
          # trigger_phrase: "/claude"
          
          # Optional: Trigger when specific user is assigned to an issue
          # assignee_trigger: "claude-bot"
          
          # Allow git operations for branch management and quality checks
          allowed_tools: >-
            Bash
            View
            GlobTool
            GrepTool
            BatchTool
            Edit
            MultiEdit
            Read
            Write
          
          # Direct prompt for continuous development
          direct_prompt: |
            CRITICAL RULES - MUST FOLLOW REGARDLESS OF PROJECT COMPLEXITY:
            
            1. PHASED DEVELOPMENT IS MANDATORY
               - NEW PROJECTS: ALWAYS implement in 4 separate phases
               - CONTINUATION TASKS: Follow task-specific phase count (1-4 phases)
               - NEVER complete multiple phases in one execution
               - Each phase MUST end with @claude-review-needed tag
               - Wait for user approval before proceeding to next phase
            
            2. Branch management for Issue #${{ github.event.issue.number }}
            
            Current situation:
            ${{ env.CLAUDE_EXISTING_BRANCH && format('- Existing branch found: {0}', env.CLAUDE_EXISTING_BRANCH) || '- No existing branch found (this appears to be Phase 1)' }}
            
            MANDATORY WORKFLOW:
            1. First, check current branch: git branch --show-current
            2. Search for existing branches: git branch -a | grep -E "project/.*-${{ github.event.issue.number }}"
            
            3. Decision logic for NEW PROJECTS (Phase 1):
               - Check if issue contains continuation tags:
                 [project: xxx], [extends: #XX], [bugfix: #XX], [enhance: #XX], 
                 [refactor: #XX], [fix: #XX], [update: #XX], [security: #XX], 
                 [docs: #XX], [test: #XX], [perf: #XX]
               - If any tags exist → This is continuation work, skip to step 4
               - Extract project name from issue title (kebab-case conversion)
                 Example: "シンプルな名刺画像生成CLIツール" → "meishi-generator"
                 Rule: Remove "- AI自動開発案件" suffix and convert to English kebab-case
               - Create project main branch: git checkout -b project/{project-name}
               - Create project directory and .project.yml
               - Push project branch: git push -u origin project/{project-name}
               - Create working branch: git checkout -b project/{project-name}-${{ github.event.issue.number }}-phase1
            
            4. Decision logic for CONTINUING WORK:
               - For Phase 2+ of same issue → Create new phase branch
                 - Determine current phase number from previous comments
                 - git checkout project/{project-name}
                 - git pull origin project/{project-name}
                 - git checkout -b project/{project-name}-${{ github.event.issue.number }}-phase{N}
               - For continuation development tasks:
                 - Extract task type from tags: fix, bugfix, enhance, refactor, update, security, docs, test, perf
                 - Extract project name:
                   * From [project: xxx] tag if present
                   * Otherwise, from referenced issue ([bugfix: #XX] → look up issue #XX's project):
                     1. Use GitHub API to get issue #XX details
                     2. Check issue #XX's labels or body for project name
                     3. Search for project branch: git branch -a | grep -E "project/.*-XX"
                     4. Extract project name from found branch
                 - git checkout project/{project-name}
                 - git pull origin project/{project-name}
                 - git checkout -b project/{project-name}-${{ github.event.issue.number }}-phase1
                 - Examples:
                   * [bugfix: #44] → branch: project/{name}-XX-phase1
                   * [enhance: #44] → branch: project/{name}-XX-phase1
                   * [refactor: #44] → branch: project/{name}-XX-phase1
            
            5. For Phase 1 ONLY - MANDATORY PROJECT DIRECTORY:
               - Create project-specific directory with kebab-case naming
               - Examples: "PDF圧縮アプリ" → pdf-compressor/, "OCRサービス" → ocr-service/
               - MUST create directory and initial README.md in Phase 1
               - Create ONLY design documents in Phase 1
               - DO NOT implement any code in Phase 1
            
            6. For continuing work (Phase 2+):
               - Ensure previous phase PR is merged
               - Run: git log --oneline -10
               - Read ALL files from previous phases
               - Build upon existing implementation
            
            7. Always report your branch name in responses
            
            8. Quality checks before commit (if applicable):
               - Run linting: npm run lint, yarn lint, ruff check, etc.
               - Run tests: npm test, pytest, etc.
               - Fix any issues before proceeding
            
            9. CRITICAL - Commit, push and create PR at the end of EVERY phase:
               - Follow the git operations in CLAUDE.md "各フェーズ完了時の必須作業" section
               - Commit and push to remote
               - Create PR using gh pr create command
               - Report PR URL in your response
               - Add comment with @claude-review-needed including PR link
               - STOP execution and wait for user response
          
          # Custom instructions for phased development
          custom_instructions: |
            ## 🌏 日本語コミュニケーション必須
            
            **絶対的ルール**: GitHubへのすべてのコメントは日本語で記述すること
            - フェーズ報告、エラーメッセージ、説明文すべて日本語使用
            - 技術用語（Phase、Branch、Issue等）は英語のまま使用可
            - コード内のコメントは英語でも可
            - 例: "Phase 1完了" ✅、"Phase 1 completed" ❌
            - ブランチ報告は必ず「**ブランチ**: `branch-name`」形式で記載
            
            ## 🚨 重要：プロジェクトブランチ戦略
            
            **絶対的なルール：すべての新規開発でプロジェクトブランチを使用**
            
            1. **ブランチ構造**:
               - システム設定: `master`（CLAUDE.md、workflowsのみ）
               - プロジェクトメイン: `project/{project-name}`
               - 作業ブランチ（Phase別）: `project/{project-name}-{issue-number}-phase{N}`
            
            2. **ブランチ確認手順**:
               CLAUDE.mdのブランチ管理手順セクションを参照してください。
            
            3. **フェーズ型開発プロセス**:
               
               **新規プロジェクト（4フェーズ）**:
               - Phase 1 (20%): 設計書を作成し、ユーザーレビューを待つ
               - Phase 2 (50%): **新しいブランチで**MVPを実装（Phase 1 PRマージ後）
               - Phase 3 (80%): **新しいブランチで**完全実装（Phase 2 PRマージ後）
               - Phase 4 (100%): **新しいブランチで**品質向上・ドキュメント整備（Phase 3 PRマージ後）
               
               **継続開発タスク（タスクタイプ別フェーズ構成）**:
               - fix（軽微な修正）: 1フェーズ（100%で完了）
               - bugfix（バグ修正）: 2フェーズ（40% → 100%）
               - enhance（機能追加）: 3フェーズ（30% → 70% → 100%）
               - refactor（リファクタリング）: 3-4フェーズ（25% → 50% → 75% → 100%）
               - update（依存関係更新）: 2-3フェーズ
               - security（セキュリティ対応）: 2-3フェーズ
               - docs（ドキュメント整備）: 1-2フェーズ
               - test（テスト追加）: 2フェーズ
               - perf（パフォーマンス改善）: 3フェーズ
            
            ## 📌 プロジェクト完了とPR作成
            
            **すべてのフェーズ（1-4）が完了し、以下の条件を満たしたら**：
            - すべての実装が完了
            - テストがパス
            - ドキュメントが整備済み
            - コードレビュー準備完了
            
            **各フェーズ完了時、プロジェクトブランチへPRを作成**：
            ```bash
            # 各フェーズでPRを作成
            gh pr create --base project/{project-name} \
                         --title "Phase {N}: {プロジェクト名}{フェーズ説明} (#${{ github.event.issue.number }})" \
                         --body "## Phase {N}完了\n\n[成果物の説明]\n\nRelated to #${{ github.event.issue.number }}"
            ```
            
            注意：
            - PRタイトルの[機能説明]は実装した機能の簡潔な説明に置き換える
            - PR本文の[実装内容の要約]は実装した機能の概要を記載
            - PR作成後、自動的にワークフローが完了を検出
            
            ## 🚨 各フェーズ完了時の必須作業
            **CLAUDE.mdの「各フェーズ完了時の必須作業」セクションを参照してください。**
            
            **重要**: 各フェーズでPR作成が必須です。PRを作成しないと、
            段階的なレビューができず、品質保証が困難になります。
            
            4. **各フェーズでの作業**:
               - プロジェクトメインブランチを最新化
               - 前フェーズのPRがマージされていることを確認
               - 前のフェーズの成果物を必ず読み込む
               - 既存の実装の上に追加実装を行う
               - git logでマージ済みコミットを確認する
            
            5. **レビューポイント**:
               - 各フェーズ完了時に`@claude-review-needed`タグを追加
               - 必ず現在のブランチ名を報告に含める
               - 例: "Phase 2完了 | PR: #102 | Branch: project/pdf-compressor-24-phase2 @claude-review-needed"
            
            6. **プロジェクト完了判定**:
               - Phase 4のPRがマージされたらプロジェクト完了
               - 品質基準を満たし、デプロイ可能な状態を確認
               - 全フェーズのPRがマージ済みであることを報告
            
            7. **禁止事項**:
               - PRを作成せずに次のフェーズに進むこと
               - 前のフェーズの成果物を無視すること
               - ゼロから再実装すること
            
            8. **エラー時の対処**:
               - ブランチが見つからない場合は、ユーザーに確認を求める
               - 勝手に新しいブランチを作成しない
          
          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test

