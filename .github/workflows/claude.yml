name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Changed from read to write for git push
      pull-requests: write  # Changed to allow PR creation
      issues: write  # Changed to allow issue updates
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
          # Always fetch all branches to find existing ones
          fetch-tags: true
          # Use the default GITHUB_TOKEN for write access
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cache Claude development state
        uses: actions/cache@v3
        with:
          path: |
            .claude/
            project-state/
          key: claude-development-${{ github.event.issue.number }}-${{ github.sha }}
          restore-keys: |
            claude-development-${{ github.event.issue.number }}-

      - name: Configure git
        run: |
          git config --global user.name "claude[bot]"
          git config --global user.email "claude[bot]@users.noreply.github.com"
          
      - name: Setup branch tracking
        run: |
          # Fetch all remote branches
          git fetch --all --prune
          
          # Check for existing branch related to this issue
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Detect current phase from issue comments or determine from context
          PHASE_NUMBER=1
          
          # Check if this is a manual phase trigger (e.g., "@claude Phase 2ã‚’é–‹å§‹ã—ã¦ãã ã•ã„")
          if [[ "${{ github.event.comment.body }}" =~ Phase[[:space:]]([0-9]) ]]; then
            DETECTED_PHASE=${BASH_REMATCH[1]}
            PHASE_NUMBER=$DETECTED_PHASE
          else
            # Detect phase from existing branches
            # æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³: project/{project-name}-{issue-number}-phase{N}
            EXISTING_PHASES=$(git branch -a | grep -E "remotes/origin/project/[^-]+-$ISSUE_NUMBER-phase[0-9]+" | grep -oE "phase[0-9]+" | grep -oE "[0-9]+" | sort -n | tail -1)
            if [ -n "$EXISTING_PHASES" ]; then
              # If phases exist, we're continuing from the last phase
              PHASE_NUMBER=$((EXISTING_PHASES + 1))
            fi
          fi
          
          echo "CLAUDE_PHASE_NUMBER=$PHASE_NUMBER" >> $GITHUB_ENV
          
          # Check for project branch pattern based on existing issue branches
          # æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³: project/{project-name}-{issue-number}-phase{N}
          PROJECT_NAME=$(git branch -a | grep -E "remotes/origin/project/[^-]+-$ISSUE_NUMBER-phase[0-9]+" | head -1 | sed -E "s|remotes/origin/(project/[^-]+)-$ISSUE_NUMBER-phase[0-9]+|\1|" | xargs)
          
          if [ -n "$PROJECT_NAME" ]; then
            PROJECT_BRANCH="$PROJECT_NAME"
            echo "Found project branch from existing phases: $PROJECT_BRANCH"
            git checkout -b "$PROJECT_BRANCH" "origin/$PROJECT_BRANCH" || git checkout "$PROJECT_BRANCH"
            git pull origin "$PROJECT_BRANCH" || echo "No remote branch yet"
            echo "CLAUDE_PROJECT_BRANCH=$PROJECT_BRANCH" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=$PROJECT_BRANCH" >> $GITHUB_ENV
          else
            echo "No project branch found for issue $ISSUE_NUMBER"
            echo "CLAUDE_PROJECT_BRANCH=" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # Specify base branch for continuity (commented out - may not be implemented yet)
          # base_branch: ${{ env.CLAUDE_BASE_BRANCH }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
          
          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          # Optional: Customize the trigger phrase (default: @claude)
          # trigger_phrase: "/claude"
          
          # Optional: Trigger when specific user is assigned to an issue
          # assignee_trigger: "claude-bot"
          
          # Allow git operations for branch management and quality checks
          allowed_tools: >-
            Bash
            View
            GlobTool
            GrepTool
            BatchTool
            Edit
            MultiEdit
            Read
            Write
          
          # Direct prompt for continuous development
          direct_prompt: |
            CRITICAL RULES - MUST FOLLOW REGARDLESS OF PROJECT COMPLEXITY:
            
            1. PHASED DEVELOPMENT IS MANDATORY
               - NEW PROJECTS: ALWAYS implement in 4 separate phases
               - CONTINUATION TASKS: Follow task-specific phase count (1-4 phases)
               - NEVER complete multiple phases in one execution
               - Each phase MUST end with @claude-review-needed tag
               - Wait for user approval before proceeding to next phase
            
            2. Branch management for Issue #${{ github.event.issue.number }}
            
            Current situation:
            ${{ env.CLAUDE_EXISTING_BRANCH && format('- Existing branch found: {0}', env.CLAUDE_EXISTING_BRANCH) || '- No existing branch found (this appears to be Phase 1)' }}
            
            MANDATORY WORKFLOW:
            1. First, check current branch: git branch --show-current
            2. Search for existing branches: git branch -a | grep -E "project/.*-${{ github.event.issue.number }}"
            
            3. Decision logic for NEW PROJECTS (Phase 1):
               - Check if issue contains continuation tags:
                 [project: xxx], [extends: #XX], [bugfix: #XX], [enhance: #XX], 
                 [refactor: #XX], [fix: #XX], [update: #XX], [security: #XX], 
                 [docs: #XX], [test: #XX], [perf: #XX]
               - If any tags exist â†’ This is continuation work, skip to step 4
               - Extract project name from issue title (kebab-case conversion)
                 Example: "ã‚·ãƒ³ãƒ—ãƒ«ãªååˆºç”»åƒç”ŸæˆCLIãƒ„ãƒ¼ãƒ«" â†’ "meishi-generator"
                 Rule: Remove "- AIè‡ªå‹•é–‹ç™ºæ¡ˆä»¶" suffix and convert to English kebab-case
               - Create project main branch: git checkout -b project/{project-name}
               - Create project directory and .project.yml
               - Push project branch: git push -u origin project/{project-name}
               - Create working branch: git checkout -b project/{project-name}-${{ github.event.issue.number }}-phase1
            
            4. Decision logic for CONTINUING WORK:
               - For Phase 2+ of same issue â†’ Create new phase branch
                 - Determine current phase number from previous comments
                 - git checkout project/{project-name}
                 - git pull origin project/{project-name}
                 - git checkout -b project/{project-name}-${{ github.event.issue.number }}-phase{N}
               - For continuation development tasks:
                 - Extract task type from tags: fix, bugfix, enhance, refactor, update, security, docs, test, perf
                 - Extract project name:
                   * From [project: xxx] tag if present
                   * Otherwise, from referenced issue ([bugfix: #XX] â†’ look up issue #XX's project):
                     1. Use GitHub API to get issue #XX details
                     2. Check issue #XX's labels or body for project name
                     3. Search for project branch: git branch -a | grep -E "project/.*-XX"
                     4. Extract project name from found branch
                 - git checkout project/{project-name}
                 - git pull origin project/{project-name}
                 - git checkout -b project/{project-name}-${{ github.event.issue.number }}-phase1
                 - Examples:
                   * [bugfix: #44] â†’ branch: project/{name}-XX-phase1
                   * [enhance: #44] â†’ branch: project/{name}-XX-phase1
                   * [refactor: #44] â†’ branch: project/{name}-XX-phase1
            
            5. For Phase 1 ONLY - MANDATORY PROJECT DIRECTORY:
               - Create project-specific directory with kebab-case naming
               - Examples: "PDFåœ§ç¸®ã‚¢ãƒ—ãƒª" â†’ pdf-compressor/, "OCRã‚µãƒ¼ãƒ“ã‚¹" â†’ ocr-service/
               - MUST create directory and initial README.md in Phase 1
               - Create ONLY design documents in Phase 1
               - DO NOT implement any code in Phase 1
            
            6. For continuing work (Phase 2+):
               - Ensure previous phase PR is merged
               - Run: git log --oneline -10
               - Read ALL files from previous phases
               - Build upon existing implementation
            
            7. Always report your branch name in responses
            
            8. Quality checks before commit (if applicable):
               - Run linting: npm run lint, yarn lint, ruff check, etc.
               - Run tests: npm test, pytest, etc.
               - Fix any issues before proceeding
            
            9. CRITICAL - Commit, push and create PR at the end of EVERY phase:
               - Follow the git operations in CLAUDE.md "å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®å¿…é ˆä½œæ¥­" section
               - Commit and push to remote
               - Create PR using gh pr create command
               - Report PR URL in your response
               - Add comment with @claude-review-needed including PR link
               - STOP execution and wait for user response
          
          # Custom instructions for phased development
          custom_instructions: |
            ## ğŸŒ æ—¥æœ¬èªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ
            
            **çµ¶å¯¾çš„ãƒ«ãƒ¼ãƒ«**: GitHubã¸ã®ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹ã“ã¨
            - ãƒ•ã‚§ãƒ¼ã‚ºå ±å‘Šã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€èª¬æ˜æ–‡ã™ã¹ã¦æ—¥æœ¬èªä½¿ç”¨
            - æŠ€è¡“ç”¨èªï¼ˆPhaseã€Branchã€Issueç­‰ï¼‰ã¯è‹±èªã®ã¾ã¾ä½¿ç”¨å¯
            - ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‹±èªã§ã‚‚å¯
            - ä¾‹: "Phase 1å®Œäº†" âœ…ã€"Phase 1 completed" âŒ
            - ãƒ–ãƒ©ãƒ³ãƒå ±å‘Šã¯å¿…ãšã€Œ**ãƒ–ãƒ©ãƒ³ãƒ**: `branch-name`ã€å½¢å¼ã§è¨˜è¼‰
            
            ## ğŸš¨ é‡è¦ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥
            
            **çµ¶å¯¾çš„ãªãƒ«ãƒ¼ãƒ«ï¼šã™ã¹ã¦ã®æ–°è¦é–‹ç™ºã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨**
            
            1. **ãƒ–ãƒ©ãƒ³ãƒæ§‹é€ **:
               - ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: `master`ï¼ˆCLAUDE.mdã€workflowsã®ã¿ï¼‰
               - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ã‚¤ãƒ³: `project/{project-name}`
               - ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒï¼ˆPhaseåˆ¥ï¼‰: `project/{project-name}-{issue-number}-phase{N}`
            
            2. **ãƒ–ãƒ©ãƒ³ãƒç¢ºèªæ‰‹é †**:
               CLAUDE.mdã®ãƒ–ãƒ©ãƒ³ãƒç®¡ç†æ‰‹é †ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
            
            3. **ãƒ•ã‚§ãƒ¼ã‚ºå‹é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹**:
               
               **æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ4ãƒ•ã‚§ãƒ¼ã‚ºï¼‰**:
               - Phase 1 (20%): è¨­è¨ˆæ›¸ã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¤
               - Phase 2 (50%): **æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã§**MVPã‚’å®Ÿè£…ï¼ˆPhase 1 PRãƒãƒ¼ã‚¸å¾Œï¼‰
               - Phase 3 (80%): **æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã§**å®Œå…¨å®Ÿè£…ï¼ˆPhase 2 PRãƒãƒ¼ã‚¸å¾Œï¼‰
               - Phase 4 (100%): **æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã§**å“è³ªå‘ä¸Šãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ï¼ˆPhase 3 PRãƒãƒ¼ã‚¸å¾Œï¼‰
               
               **ç¶™ç¶šé–‹ç™ºã‚¿ã‚¹ã‚¯ï¼ˆã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¥ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆï¼‰**:
               - fixï¼ˆè»½å¾®ãªä¿®æ­£ï¼‰: 1ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ100%ã§å®Œäº†ï¼‰
               - bugfixï¼ˆãƒã‚°ä¿®æ­£ï¼‰: 2ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ40% â†’ 100%ï¼‰
               - enhanceï¼ˆæ©Ÿèƒ½è¿½åŠ ï¼‰: 3ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ30% â†’ 70% â†’ 100%ï¼‰
               - refactorï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰: 3-4ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ25% â†’ 50% â†’ 75% â†’ 100%ï¼‰
               - updateï¼ˆä¾å­˜é–¢ä¿‚æ›´æ–°ï¼‰: 2-3ãƒ•ã‚§ãƒ¼ã‚º
               - securityï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰: 2-3ãƒ•ã‚§ãƒ¼ã‚º
               - docsï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ï¼‰: 1-2ãƒ•ã‚§ãƒ¼ã‚º
               - testï¼ˆãƒ†ã‚¹ãƒˆè¿½åŠ ï¼‰: 2ãƒ•ã‚§ãƒ¼ã‚º
               - perfï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰: 3ãƒ•ã‚§ãƒ¼ã‚º
            
            ## ğŸ“Œ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ã¨PRä½œæˆ
            
            **ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1-4ï¼‰ãŒå®Œäº†ã—ã€ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã—ãŸã‚‰**ï¼š
            - ã™ã¹ã¦ã®å®Ÿè£…ãŒå®Œäº†
            - ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ•´å‚™æ¸ˆã¿
            - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†
            
            **å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ–ãƒ©ãƒ³ãƒã¸PRã‚’ä½œæˆ**ï¼š
            ```bash
            # å„ãƒ•ã‚§ãƒ¼ã‚ºã§PRã‚’ä½œæˆ
            gh pr create --base project/{project-name} \
                         --title "Phase {N}: {ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå}{ãƒ•ã‚§ãƒ¼ã‚ºèª¬æ˜} (#${{ github.event.issue.number }})" \
                         --body "## Phase {N}å®Œäº†\n\n[æˆæœç‰©ã®èª¬æ˜]\n\nRelated to #${{ github.event.issue.number }}"
            ```
            
            æ³¨æ„ï¼š
            - PRã‚¿ã‚¤ãƒˆãƒ«ã®[æ©Ÿèƒ½èª¬æ˜]ã¯å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®ç°¡æ½”ãªèª¬æ˜ã«ç½®ãæ›ãˆã‚‹
            - PRæœ¬æ–‡ã®[å®Ÿè£…å†…å®¹ã®è¦ç´„]ã¯å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®æ¦‚è¦ã‚’è¨˜è¼‰
            - PRä½œæˆå¾Œã€è‡ªå‹•çš„ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã‚’æ¤œå‡º
            
            ## ğŸš¨ å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®å¿…é ˆä½œæ¥­
            **CLAUDE.mdã®ã€Œå„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®å¿…é ˆä½œæ¥­ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**
            
            **é‡è¦**: å„ãƒ•ã‚§ãƒ¼ã‚ºã§PRä½œæˆãŒå¿…é ˆã§ã™ã€‚PRã‚’ä½œæˆã—ãªã„ã¨ã€
            æ®µéšçš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã§ããšã€å“è³ªä¿è¨¼ãŒå›°é›£ã«ãªã‚Šã¾ã™ã€‚
            
            4. **å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ä½œæ¥­**:
               - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‚’æœ€æ–°åŒ–
               - å‰ãƒ•ã‚§ãƒ¼ã‚ºã®PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®æˆæœç‰©ã‚’å¿…ãšèª­ã¿è¾¼ã‚€
               - æ—¢å­˜ã®å®Ÿè£…ã®ä¸Šã«è¿½åŠ å®Ÿè£…ã‚’è¡Œã†
               - git logã§ãƒãƒ¼ã‚¸æ¸ˆã¿ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹
            
            5. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ**:
               - å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã«`@claude-review-needed`ã‚¿ã‚°ã‚’è¿½åŠ 
               - å¿…ãšç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å ±å‘Šã«å«ã‚ã‚‹
               - ä¾‹: "Phase 2å®Œäº† | PR: #102 | Branch: project/pdf-compressor-24-phase2 @claude-review-needed"
            
            6. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†åˆ¤å®š**:
               - Phase 4ã®PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†
               - å“è³ªåŸºæº–ã‚’æº€ãŸã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªçŠ¶æ…‹ã‚’ç¢ºèª
               - å…¨ãƒ•ã‚§ãƒ¼ã‚ºã®PRãŒãƒãƒ¼ã‚¸æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’å ±å‘Š
            
            7. **ç¦æ­¢äº‹é …**:
               - PRã‚’ä½œæˆã›ãšã«æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã‚€ã“ã¨
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®æˆæœç‰©ã‚’ç„¡è¦–ã™ã‚‹ã“ã¨
               - ã‚¼ãƒ­ã‹ã‚‰å†å®Ÿè£…ã™ã‚‹ã“ã¨
            
            8. **ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å‡¦**:
               - ãƒ–ãƒ©ãƒ³ãƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹
               - å‹æ‰‹ã«æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ãªã„
          
          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test

