name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Changed from read to write for git push
      pull-requests: write  # Changed to allow PR creation
      issues: write  # Changed to allow issue updates
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
          # Always fetch all branches to find existing ones
          fetch-tags: true
          # Use the default GITHUB_TOKEN for write access
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cache Claude development state
        uses: actions/cache@v3
        with:
          path: |
            .claude/
            project-state/
          key: claude-development-${{ github.event.issue.number }}-${{ github.sha }}
          restore-keys: |
            claude-development-${{ github.event.issue.number }}-

      - name: Configure git
        run: |
          git config --global user.name "claude[bot]"
          git config --global user.email "claude[bot]@users.noreply.github.com"
          
      - name: Setup branch tracking
        run: |
          # Fetch all remote branches
          git fetch --all --prune
          
          # Check for existing branch related to this issue
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          EXISTING_BRANCH=$(git branch -a | grep -E "remotes/origin/.*issue-${ISSUE_NUMBER}" | head -1 | sed 's/remotes\/origin\///' | xargs)
          
          if [ -n "$EXISTING_BRANCH" ]; then
            echo "Found existing branch: $EXISTING_BRANCH"
            git checkout -b "$EXISTING_BRANCH" "origin/$EXISTING_BRANCH" || git checkout "$EXISTING_BRANCH"
            echo "CLAUDE_EXISTING_BRANCH=$EXISTING_BRANCH" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=$EXISTING_BRANCH" >> $GITHUB_ENV
          else
            echo "No existing branch found for issue $ISSUE_NUMBER"
            echo "CLAUDE_EXISTING_BRANCH=" >> $GITHUB_ENV
            echo "CLAUDE_BASE_BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # Specify base branch for continuity (commented out - may not be implemented yet)
          # base_branch: ${{ env.CLAUDE_BASE_BRANCH }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
          
          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          # Optional: Customize the trigger phrase (default: @claude)
          # trigger_phrase: "/claude"
          
          # Optional: Trigger when specific user is assigned to an issue
          # assignee_trigger: "claude-bot"
          
          # Allow git operations for branch management and quality checks
          allowed_tools: >-
            Bash
            View
            GlobTool
            GrepTool
            BatchTool
            Edit
            MultiEdit
            Read
            Write
          
          # Direct prompt for continuous development
          direct_prompt: |
            CRITICAL RULES - MUST FOLLOW REGARDLESS OF PROJECT COMPLEXITY:
            
            1. PHASED DEVELOPMENT IS MANDATORY
               - ALWAYS implement in 4 separate phases
               - NEVER complete multiple phases in one execution
               - Each phase MUST end with @claude-review-needed tag
               - Wait for user approval before proceeding to next phase
            
            2. Branch management for Issue #${{ github.event.issue.number }}
            
            Current situation:
            ${{ env.CLAUDE_EXISTING_BRANCH && format('- Existing branch found: {0}', env.CLAUDE_EXISTING_BRANCH) || '- No existing branch found (this appears to be Phase 1)' }}
            
            MANDATORY WORKFLOW:
            1. First, check current branch: git branch --show-current
            2. Search for existing branches: git branch -a | grep "issue-${{ github.event.issue.number }}"
            
            3. Decision logic:
               - If existing branch found â†’ Use it (NEVER create a new one)
                 - git checkout {existing-branch}
                 - git pull origin {existing-branch}
               - If no existing branch â†’ This is Phase 1, create: git checkout -b claude/issue-${{ github.event.issue.number }}-$(date +%Y%m%d_%H%M%S)
            
            4. For Phase 1 ONLY - MANDATORY PROJECT DIRECTORY:
               - Create project-specific directory with kebab-case naming
               - Examples: "PDFåœ§ç¸®ã‚¢ãƒ—ãƒª" â†’ pdf-compressor/, "OCRã‚µãƒ¼ãƒ“ã‚¹" â†’ ocr-service/
               - MUST create directory and initial README.md in Phase 1
               - Create ONLY design documents in Phase 1
               - DO NOT implement any code in Phase 1
            
            5. For continuing work (Phase 2+):
               - Run: git log --oneline -10
               - Read ALL files from previous phases
               - Build upon existing implementation
            
            6. Always report your branch name in responses
            
            7. Quality checks before commit (if applicable):
               - Run linting: npm run lint, yarn lint, ruff check, etc.
               - Run tests: npm test, pytest, etc.
               - Fix any issues before proceeding
            
            8. CRITICAL - Commit and push at the end of EVERY phase:
               - git add -A
               - git commit -m "feat: Phase X implementation for Issue #${{ github.event.issue.number }}"
               - git push origin {your-branch-name}
               - NEVER complete a phase without pushing to remote
               - After push, add comment with @claude-review-needed
               - STOP execution and wait for user response
          
          # Custom instructions for phased development
          custom_instructions: |
            ## ğŸš¨ é‡è¦ï¼šãƒ–ãƒ©ãƒ³ãƒç®¡ç†ãƒ«ãƒ¼ãƒ«
            
            **çµ¶å¯¾çš„ãªãƒ«ãƒ¼ãƒ«ï¼šå„Issue/PRã«å¯¾ã—ã¦å˜ä¸€ã®ãƒ–ãƒ©ãƒ³ãƒã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨**
            
            1. **ãƒ–ãƒ©ãƒ³ãƒåã®è¦å‰‡**:
               - æ–°è¦ä½œæˆæ™‚ã®ã¿: `claude/issue-{issue_number}-{timestamp}`
               - æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚‹å ´åˆ: ãã®ãƒ–ãƒ©ãƒ³ãƒã‚’å¿…ãšä½¿ç”¨
            
            2. **ãƒ–ãƒ©ãƒ³ãƒç¢ºèªæ‰‹é †**ï¼ˆæ¯å›å®Ÿè¡Œï¼‰:
               ```bash
               # ç¾åœ¨ã®Issueã«é–¢é€£ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œç´¢
               git branch -a | grep "issue-{issue_number}"
               
               # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚‹å ´åˆ â†’ å¿…ãšãã‚Œã‚’ä½¿ç”¨
               git checkout {existing-branch-name}
               git pull origin {existing-branch-name}
               
               # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒãªã„å ´åˆ â†’ Phase 1ãªã®ã§æ–°è¦ä½œæˆ
               git checkout -b claude/issue-{issue_number}-{timestamp}
               ```
            
            3. **ãƒ•ã‚§ãƒ¼ã‚ºå‹é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹**:
               - Phase 1 (20%): è¨­è¨ˆæ›¸ã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¤
               - Phase 2 (50%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**MVPã‚’å®Ÿè£…
               - Phase 3 (80%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**å®Œå…¨å®Ÿè£…
               - Phase 4 (100%): **åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§**å®Œæˆã—ã¦PRã‚’ä½œæˆ
                 - å¿…é ˆ: ã‚³ãƒ¡ãƒ³ãƒˆã«ã€PHASE4_COMPLETEã€‘ãƒãƒ¼ã‚«ãƒ¼ã‚’å«ã‚ã‚‹
            
            ## ğŸ“Œ Phase 4å®Œäº†æ™‚ã®å¿…é ˆãƒãƒ¼ã‚«ãƒ¼
            **é‡è¦**: Phase 4ã®å…¨ä½œæ¥­ãŒå®Œäº†ã—ã€æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ãŒæˆåŠŸã—ãŸå¾Œã€
            å¿…ãš**åˆ¥ã®æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆ**ã¨ã—ã¦ä»¥ä¸‹ã®ãƒãƒ¼ã‚«ãƒ¼ã®ã¿ã‚’æŠ•ç¨¿ã™ã‚‹ã“ã¨ï¼š
            
            ```
            ã€PHASE4_COMPLETEã€‘
            ```
            
            æ³¨æ„: 
            - Phase 4ã®ä½œæ¥­å ±å‘Šã¨ã¯åˆ¥ã«ã€ç‹¬ç«‹ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
            - ã“ã®ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒå®Œäº†é€šçŸ¥ã®ãƒˆãƒªã‚¬ãƒ¼ã¨ãªã‚‹
            - Phase 4ã®ä½œæ¥­ä¸­ã‚„å ±å‘Šå†…ã«ã¯ã“ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å«ã‚ãªã„ã“ã¨
            
            ## ğŸš¨ å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã®å¿…é ˆä½œæ¥­
            **çµ¶å¯¾çš„ãƒ«ãƒ¼ãƒ«ï¼šå„ãƒ•ã‚§ãƒ¼ã‚ºã®ä½œæ¥­ã‚’å®Œäº†ã™ã‚‹å‰ã«å¿…ãšä»¥ä¸‹ã‚’å®Ÿè¡Œ**
            
            ```bash
            # 1. ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
            git add -A
            
            # 2. ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚’ã‚³ãƒŸãƒƒãƒˆ
            git commit -m "feat: Phase X implementation for Issue #${{ github.event.issue.number }}"
            
            # 3. ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆã“ã‚Œã‚’å¿˜ã‚Œã‚‹ã¨æ¬¡å›æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒãŒä½œæˆã•ã‚Œã‚‹ï¼ï¼‰
            git push origin {ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒå}
            ```
            
            **è­¦å‘Š**: ãƒ—ãƒƒã‚·ãƒ¥ã‚’å¿˜ã‚Œã‚‹ã¨ã€æ¬¡å›ã®å®Ÿè¡Œæ™‚ã«æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒè¦‹ã¤ã‹ã‚‰ãšã€
            æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒãŒä½œæˆã•ã‚Œã¦ã—ã¾ã„ã€ãƒ•ã‚§ãƒ¼ã‚ºé–“ã®é€£ç¶šæ€§ãŒå¤±ã‚ã‚Œã¾ã™ã€‚
            
            4. **å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ä½œæ¥­**:
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚³ãƒ¼ãƒ‰ã‚’å¿…ãšèª­ã¿è¾¼ã‚€
               - æ—¢å­˜ã®å®Ÿè£…ã®ä¸Šã«è¿½åŠ å®Ÿè£…ã‚’è¡Œã†
               - æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ãƒ»ç½®æ›ã›ãšã€æ”¹å–„ãƒ»æ‹¡å¼µã™ã‚‹
               - git logã§å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹
            
            5. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ**:
               - å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã«`@claude-review-needed`ã‚¿ã‚°ã‚’è¿½åŠ 
               - å¿…ãšç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å ±å‘Šã«å«ã‚ã‚‹
               - ä¾‹: "Phase 2å®Œäº† (branch: claude/issue-24-20250712_012315) @claude-review-needed"
            
            6. **ç¦æ­¢äº‹é …**:
               - æ–°ã—ã„ãƒ•ã‚§ãƒ¼ã‚ºã§æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹ã“ã¨
               - å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…ã‚’ç„¡è¦–ã™ã‚‹ã“ã¨
               - ã‚¼ãƒ­ã‹ã‚‰å†å®Ÿè£…ã™ã‚‹ã“ã¨
            
            7. **ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å‡¦**:
               - ãƒ–ãƒ©ãƒ³ãƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹
               - å‹æ‰‹ã«æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ãªã„
          
          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test

